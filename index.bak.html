<!DOCTYPE html>
<html>
<head>
<title>Google Maps Waypoint Creator</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />


<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>

<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>

<script type="text/javascript">
  var map;
  var initPos = new google.maps.LatLng(13.191949594259992, -59.64082454358599);
  var styleArray = [
    {
    featureType: "road",
    stylers: [
      { visibility: "off" }
      ]
    }
  ];
  var mapOptions = {
    zoom: 19,
    center: initPos,
    panControl: true,
    zoomControl: true,
    mapTypeControl: false,
    scaleControl: true,
    streetViewControl: false,
//    styles: styleArray,
//    mapTypeId: google.maps.MapTypeId.SATELLITE
    mapTypeId: google.maps.MapTypeId.HYBRID
  };
  var waypointMarkers = new Array();
  var displayIDs = new Boolean();
  var waypointLines = null;
  var geocoder;

  function initialize() {
    // Initialize new Google map widget
    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    google.maps.event.addListener(map, 'click', addWaypoint);
	google.maps.event.addListener(map, 'mousemove', mouseMove);
    google.maps.event.addListener(map, 'center_changed', updateCenterPos);
    updateCenterPos();
    geocoder = new google.maps.Geocoder();

    // Disable copy-to-clipboard buttons if feature not available
    //if (!window.clipboardData) {
    //  document.getElementById("currGCSCopyClipboard").style.visibility = "hidden";
    //  document.getElementById("waypointsCopyClipboard").style.visibility = "hidden";
    //}
    
    // Add buttons
    var buttonControlDiv = document.createElement('DIV');
    var buttonControl = new ButtonControl(buttonControlDiv, map);
    buttonControlDiv.index = 1;
    map.controls[google.maps.ControlPosition.TOP_RIGHT].push(buttonControlDiv);
  };

  function updateCenterPos(event) {
    document.info.currGCS.value = map.getCenter();
  };
  
  function ButtonControl(controlDiv, map) {
    controlDiv.style.padding = '5px';

    var addWpUI = document.createElement('DIV');
    addWpUI.style.backgroundColor = 'white';
    addWpUI.style.borderStyle = 'solid';
    addWpUI.style.borderWidth = '2px';
    addWpUI.style.cursor = 'pointer';
    addWpUI.style.textAlign = 'center';
    addWpUI.title = 'Click to add new waypoint';
    controlDiv.appendChild(addWpUI);

    var addWpText = document.createElement('DIV');
    addWpText.style.fontFamily = 'Arial,sans-serif';
    addWpText.style.fontSize = '12px';
    addWpText.style.paddingLeft = '4px';
    addWpText.style.paddingRight = '4px';
    addWpText.innerHTML = 'Add Wpt.';
    addWpUI.appendChild(addWpText);

    google.maps.event.addDomListener(addWpUI, 'click', addWaypoint);

    var delWpUI = document.createElement('DIV');
    delWpUI.style.backgroundColor = 'white';
    delWpUI.style.borderStyle = 'solid';
    delWpUI.style.borderWidth = '2px';
    delWpUI.style.cursor = 'pointer';
    delWpUI.style.textAlign = 'center';
    delWpUI.title = 'Click to delete last waypoint';
    controlDiv.appendChild(delWpUI);

    var delWpText = document.createElement('DIV');
    delWpText.style.fontFamily = 'Arial,sans-serif';
    delWpText.style.fontSize = '12px';
    delWpText.style.paddingLeft = '4px';
    delWpText.style.paddingRight = '4px';
    delWpText.innerHTML = 'Del. Wpt.';
    delWpUI.appendChild(delWpText);

    google.maps.event.addDomListener(delWpUI, 'click', removeWaypoint);

    var clrWpUI = document.createElement('DIV');
    clrWpUI.style.backgroundColor = 'white';
    clrWpUI.style.borderStyle = 'solid';
    clrWpUI.style.borderWidth = '2px';
    clrWpUI.style.cursor = 'pointer';
    clrWpUI.style.textAlign = 'center';
    clrWpUI.title = 'Click to clear all waypoints';
    controlDiv.appendChild(clrWpUI);

    var clrWpText = document.createElement('DIV');
    clrWpText.style.fontFamily = 'Arial,sans-serif';
    clrWpText.style.fontSize = '12px';
    clrWpText.style.paddingLeft = '4px';
    clrWpText.style.paddingRight = '4px';
    clrWpText.innerHTML = 'Clear All';
    clrWpUI.appendChild(clrWpText);

    google.maps.event.addDomListener(clrWpUI, 'click', clearWaypoints);
  };
  
  function mouseMove(event) {
    console.log("mouse moved to " + event.latLng);
	
  }
  
  function addWaypoint(event) {
    var pos;
    if (event == null || event.latLng == null) {
      pos = map.getCenter();
    } else {
      pos = event.latLng;
    }

    waypointMarkers.push(new google.maps.Marker({
      map: map,
      draggable: true,
      animation: google.maps.Animation.DROP,
      clickable: true,
      position: pos,
      raiseOnDrag: true,
      title: "" + (waypointMarkers.length+1)
    }));
    google.maps.event.addListener(waypointMarkers[waypointMarkers.length-1],
    'position_changed', redrawWaypoints);
    redrawWaypoints();
  };
  
  function removeWaypoint() {
    if (waypointMarkers.length > 0) {
      var removedMarker = waypointMarkers.pop();
      removedMarker.setMap(null);
      google.maps.event.clearListeners(removedMarker, 'position_changed');
      redrawWaypoints();
    }
  };

  function clearWaypoints() {
    while (waypointMarkers.length > 0) {
      var removedMarker = waypointMarkers.pop();
      removedMarker.setMap(null);
      google.maps.event.clearListeners(removedMarker, 'position_changed');
    }
    redrawWaypoints();
  };
  
  function redrawWaypoints() {
    // NOTE: No need to redraw actual markers since they are handled automatically

    // Remove previous polyline and draw new one
    if (waypointLines != null) {
      waypointLines.setMap(null);
    }
    var waypointCoordinates = new Array();
    var i;
    for (i = 0; i < waypointMarkers.length; i++) {
      waypointCoordinates[i] = waypointMarkers[i].position;
    }
    waypointLines = new google.maps.Polyline({
      path: waypointCoordinates,
      strokeColor: "#FFFFFF",
      strokeOpacity: 0.8,
      strokeWeight: 4
    });
    waypointLines.setMap(map);

    updateListText();
  };

  function setClipboardText(text) {
    if (window.clipboardData) {
      window.clipboardData.setData("Text",text);
    }
  };
  
  function toggleIDs() {
    displayIDs = !displayIDs;
    updateListText();
  };
  
  function updateListText() {
    var i = 0;
    var text = "";
    for (i = 0; i < waypointMarkers.length; i++) {
      if (displayIDs) {
        text += (i+1) + " ";
      }
      text += waypointMarkers[i].position + "\n";
    }
    document.info.list.value = text;
  };

  function geocodeQuery() {
    var address = document.getElementById("address").value;
    geocoder.geocode({'address': address}, geocodeResponse);
  };

  function geocodeResponse(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      map.setCenter(results[0].geometry.location);
      map.fitBounds(results[0].geometry.viewport);
    } else if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
      document.getElementById("address").value = "No Results";
    } else {
      document.getElementById("address").value = "Query Failed";
    }
  };

  function clearAddressTextbox() {
    document.getElementById("address").value = "";
  };
  
  function parseLatLonString(latlon_string) {
    var latlon = new Array();
    if (latlon_string === undefined) {
      return latlon;
    }
    latlon_string = latlon_string.replace(/\(/g, ' ').replace(/\)/g, ' ').replace(/,/g, ' ').replace(/;/g, ' ').replace(/^\s+|\s+$/g,'').replace(/\s+/g,' ');
    var tokens = latlon_string.split(' ');
    var tempLat = 361;
    var count = 0;
    for (var i = 0; i < tokens.length; i++) {
      var tempNum = parseFloat(tokens[i]);
      if (tempLat == 361) {
        if (!isNaN(tempNum) && tempNum >= -90 && tempNum <= 90) { // Parse latitude
          tempLat = tempNum;
        } else {
          alert('Parser failed on token ' + (i + 1).toString() +
            ' (out of ' + tokens.length.toString() + '):\n\'' +
            tokens[i] + '\' is not a valid latitude.');
          break;
        }
      } else {
        if (!isNaN(tempNum) && tempNum >= -180 && tempNum <= 180) { // Parse longitude
          //alert('Found GCS: (' + tempLat.toString() + ', ' + tempNum.toString() + ')');
          latlon[2*count] = tempLat;
          latlon[2*count + 1] = tempNum;
          count += 1;
          tempLat = 361;
        } else {
          alert('Parser failed on token ' + (i + 1).toString() +
            ' (out of ' + tokens.length.toString() + '):\n\'' +
            tokens[i] + '\' is not a valid longitude.');
          break;
        }
      }
    }
    return latlon;
  };
  
  function LatLngPoint(lat, lon) {
    this.latLng = new google.maps.LatLng(lat, lon);
  };

  function parseInput() {
    var input = prompt("Enter latitude-longitude pairs in decimal degree format", "e.g. lat1, lon1, (lat2, lon2); ...");
    var latlon = parseLatLonString(input);
    if (latlon.length > 1) {
      clearWaypoints();
      var latlngBnds = new google.maps.LatLngBounds();
      for (var i = 0; i < latlon.length - 1; i += 2) {
        var currPt = new LatLngPoint(latlon[i], latlon[i + 1]);
        addWaypoint(currPt);
        latlngBnds.extend(currPt.latLng);
      }
      map.fitBounds(latlngBnds);
      //map.setCenter(currPt.latLng);
      updateCenterPos();
    }
  };
</script>

</head>

<body onload="initialize()">
<div style="text-align:center">
<input id="address" type="textbox" onfocus="clearAddressTextbox()" value="Enter Address/GCS">
<input type="button" value="Search" onclick="geocodeQuery()">
</div> 
<div id="map_canvas" style="width:100%; height:70%"></div>

<div>

</div>


<div style="text-align:center">
<form name=info>
Current Position (Lat, Lon):<br>
<input name=currGCS type=text size=50 style="font-family:inherit"><br>
Waypoints (Lat, Lon):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:void(0)" onclick="toggleIDs()">Toggle ID</a><br>
<textarea name=list rows=6 cols=53 style="font-family:inherit"></textarea><br>
<input type="button" name="parseInputBtn" value="Parse..." onclick="parseInput()"><br>
<!--<input type="button" name="currGCSCopyClipboard" value="Copy Curr. Pos." onclick="setClipboardText(document.info.currGCS.value);">&nbsp;&nbsp;
<input type="button" name="waypointsCopyClipboard" value="Copy Waypoints" onclick="setClipboardText(document.info.list.value);"><br>-->
</form>
<p style="font-size:75%">
Created by <a href="http://www.cim.mcgill.ca/~anqixu/" target="new">Anqi Xu</a> using
<a href="http://code.google.com/apis/maps/documentation/javascript/" target="new">Google Maps API</a></p>
</div>
</body>

</html>
